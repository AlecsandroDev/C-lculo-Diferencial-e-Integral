<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CalcTool Pro - Calculadora Visual</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <!-- REMOVIDO: polyfill QUEBRADO -->
    <!-- <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> -->

    <!-- MathJax -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* ---------- Layout geral ---------- */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            margin-bottom: 50px;
        }

        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header-section h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0;
        }

        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
        }

        /* ---------- Resultado + step-by-step ---------- */
        .resultado-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
            margin-top: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .resultado-math {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            margin-bottom: 1.25rem;
            text-align: center;
            font-size: 1.05rem;
            line-height: 2;
        }

        .step-item {
            background: white;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 5px solid #667eea;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
            font-size: 0.98rem;
        }

        /* ---------- Chart + controls ---------- */
        #main-chart {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-top: 1rem;
            width: 100%;
            height: 600px;
        }

        .controles-integral {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
        }

        .badge-dinamico {
            background: #667eea;
            color: #fff;
            padding: 0.35rem 0.85rem;
            border-radius: 20px;
            font-weight: 600;
        }

        .area-box {
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="main-card">
            <div class="header-section">
                <h1>üìä CalcTool Pro</h1>
                <p>Visualiza√ß√£o interativa de C√°lculo Diferencial e Integral</p>
            </div>

            <!-- NAV TABS -->
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link {% if aba_ativa == 'limite' %}active{% endif %}"
                        onclick="mudarAba('limite')">
                        Limites
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link {% if aba_ativa == 'derivada' %}active{% endif %}"
                        onclick="mudarAba('derivada')">
                        Derivada
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link {% if aba_ativa == 'pontos_criticos' %}active{% endif %}"
                        onclick="mudarAba('pontos_criticos')">
                        Pontos Cr√≠ticos
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link {% if aba_ativa == 'integral' %}active{% endif %}"
                        onclick="mudarAba('integral')">
                        Integral
                    </button>
                </li>
            </ul>

            <!-- FORM CONTROLS -->
            <div class="p-4">
                <form method="POST" action="/">
                    <input type="hidden" name="aba_ativa" id="input_aba_ativa" value="{{ aba_ativa }}">

                    <div class="mb-4">
                        <label class="form-label fw-bold">üìê Fun√ß√£o f(x):</label>
                        <input type="text" class="form-control form-control-lg" name="funcao" value="{{ funcao }}"
                            placeholder="Ex: x**2, sin(x), 1/(x-2)" required>
                        <small class="text-muted">Use: ** (pot√™ncia), sqrt(), sin/cos/tan, exp(), log()</small>
                    </div>

                    <!-- Limite config -->
                    <div class="config-aba" id="div-limite" {% if aba_ativa !='limite' %}style="display:none" {% endif
                        %}>
                        <label class="form-label">Ponto de tend√™ncia (x ‚Üí p):</label>
                        <input type="number" step="any" class="form-control" name="ponto_limite"
                            value="{{ params.ponto }}">
                    </div>



                    <!-- Integral config -->
                    <div class="config-aba" id="div-integral" {% if aba_ativa !='integral' %}style="display:none" {%
                        endif %}>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">In√≠cio do intervalo (a):</label>
                                <input type="number" step="any" class="form-control" name="int_a"
                                    value="{{ params.int_a }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Fim do intervalo (b):</label>
                                <input type="number" step="any" class="form-control" name="int_b"
                                    value="{{ params.int_b }}">
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 btn-lg mt-4">üöÄ Calcular e Visualizar</button>
                </form>
            </div>

            <!-- RESULTADO E GR√ÅFICOS -->
            {% if resultado %}
            <div class="resultado-card mx-4 mb-4">
                <h4 class="text-center mb-3" style="color: #667eea; font-weight:700;">üìà Resultado Final</h4>

                <div class="resultado-math">
                    $$ {{ resultado | safe }} $$
                </div>

                {% if steps %}
                <div class="step-by-step">
                    <h5 style="color:#667eea; font-weight:700;">üìù Resolu√ß√£o Passo a Passo</h5>
                    {% for step in steps %}
                    <div class="step-item">$$ {{ step | safe }} $$</div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if dados_grafico %}
                <hr class="my-4">

                <h4 class="text-center mb-3" style="color:#667eea;">üìä Visualiza√ß√£o Gr√°fica Interativa</h4>

                <!-- Controles din√¢micos (integral / sliders) -->
                <div id="controles-dinamicos" style="display:none;">
                    <div class="controles-integral">
                        <h6 style="color:#667eea; font-weight:700;" class="text-center">üéöÔ∏è Controle Din√¢mico de
                            Aproxima√ß√£o</h6>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <div class="area-box"
                                    style="background: linear-gradient(135deg,#e8f4fc 0%,#c3e0f7 100%); border:2px solid #3498db;">
                                    <h6 style="color:#2980b9">Integral L√≠quida</h6>
                                    <div class="valor" id="integral_liquida_display" style="color:#2980b9">-</div>
                                    <small class="text-muted">Soma Riemann: <strong
                                            id="soma_liquida_display">-</strong></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="area-box"
                                    style="background: linear-gradient(135deg,#fef5e7 0%,#fdeaa8 100%); border:2px solid #f39c12;">
                                    <h6 style="color:#e67e22">√Årea Geom√©trica</h6>
                                    <div class="valor" id="area_geometrica_display" style="color:#e67e22">-</div>
                                    <small class="text-muted">Soma Riemann: <strong
                                            id="soma_absoluta_display">-</strong></small>
                                </div>
                            </div>
                        </div>

                        <label class="form-label d-block text-center">
                            N√∫mero de Ret√¢ngulos: <span class="badge-dinamico" id="val_n_dinamico">10</span>
                        </label>
                        <input type="range" class="form-range" min="1" max="200" id="slider_dinamico" value="10">
                    </div>
                </div>

                <div id="controle-derivada" style="display:none; margin-top:20px;">
                    <div class="controles-integral" style="padding:15px;">
                        <label class="form-label d-block text-center">
                            Ponto da Reta Tangente:
                            <span class="badge-dinamico" id="val_ponto_tangente_form">0</span>
                        </label>

                        <input type="range" class="form-range" min="-10" max="10" step="0.1"
                            id="slider_ponto_tangente_form" value="0">
                    </div>
                </div>

                <div id="main-chart"></div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- -------------- Scripts -------------- -->
    <script>
        // Mudar aba (apenas altera o campo hidden e o visual local)
        function mudarAba(aba) {
            document.getElementById('input_aba_ativa').value = aba;
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));

            try { event.target.classList.add('active'); } catch (e) { }

            document.querySelectorAll('.config-aba').forEach(el => el.style.display = 'none');

            if (aba === 'limite') {
                document.getElementById('div-limite').style.display = 'block';
            } else if (aba === 'derivada') {
                document.getElementById('div-derivada').style.display = 'block';
            } else if (aba === 'integral') {
                document.getElementById('div-integral').style.display = 'block';
            }
        }
    </script>

    <!-- ---------- Script do gr√°fico ---------- -->
    {% if dados_grafico %}
    <script>
        (function () {

            const dadosOriginais = {{ dados_grafico | tojson | safe
        }};

        const chartDom = document.getElementById('main-chart');
        const myChart = echarts.init(chartDom);

        const xs = Array.isArray(dadosOriginais.eixo_x) ? dadosOriginais.eixo_x : [];
        const ys = Array.isArray(dadosOriginais.eixo_y)
            ? dadosOriginais.eixo_y.map(v => (typeof v === 'number' && isFinite(v) ? v : null))
            : [];

        const commonConfig = {
            toolbox: {
                feature: {
                    dataZoom: { yAxisIndex: 'none' },
                    restore: {},
                    saveAsImage: { name: 'calctool_grafico' }
                },
                right: 20,
                top: 10
            },
            tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
            grid: { left: '8%', right: '8%', bottom: '12%', top: '12%', containLabel: true },
            dataZoom: [
                { type: 'inside', xAxisIndex: 0 },
                { type: 'slider', xAxisIndex: 0, bottom: '5%' }
            ],
            xAxis: { type: 'value', name: 'x', nameLocation: 'middle', nameGap: 28 },
            yAxis: { type: 'value', name: 'f(x)', nameLocation: 'middle', nameGap: 40 }
        };

        let option = {};

        /* -------------------- LIMITE -------------------- */
        if (dadosOriginais.tipo === 'limite') {

            const pt = dadosOriginais.ponto_destaque || {};
            const yHighlight = (typeof pt.y === 'number' && isFinite(pt.y)) ? pt.y : null;
            const isAberta = pt.estilo === 'aberta';

            option = {
                ...commonConfig,
                title: { text: 'An√°lise de Limite e Continuidade', left: 'center', textStyle: { fontSize: 16 } },
                legend: { data: ['f(x)', isAberta ? 'Bolinha Aberta (‚óã)' : 'Bolinha Fechada (‚óè)'], top: 36 },
                series: [
                    {
                        name: "f(x) esquerda",
                        type: "line",
                        connectNulls: false,
                        data: dadosOriginais.eixo_x.map((x, i) => {
                            const y = dadosOriginais.y_esquerda[i];
                            return y === null ? null : [x, y];
                        }),
                        showSymbol: false,
                    },
                    {
                        name: "f(x) direita",
                        type: "line",
                        connectNulls: false,
                        data: dadosOriginais.eixo_x.map((x, i) => {
                            const y = dadosOriginais.y_direita[i];
                            return y === null ? null : [x, y];
                        }),
                        showSymbol: false,
                    },
                    {
                        name: isAberta ? 'Bolinha Aberta (‚óã)' : 'Bolinha Fechada (‚óè)',
                        type: 'scatter',
                        data: [[pt.x, yHighlight]],
                        symbolSize: 22,
                        itemStyle: {
                            color: isAberta ? '#ffffff' : '#e74c3c',
                            borderColor: '#e74c3c',
                            borderWidth: 3
                        },
                        label: {
                            show: true,
                            formatter: function (p) {
                                const xv = p.value[0];
                                const yv = p.value[1];
                                return (typeof yv === 'number' && isFinite(yv))
                                    ? `(${xv.toFixed(2)}, ${yv.toFixed(2)})`
                                    : `(${xv.toFixed(2)}, n/a)`;
                            },
                            position: 'top',
                            backgroundColor: 'rgba(255,255,255,0.95)',
                            padding: [6, 10],
                            borderRadius: 6
                        },
                        z: 10
                    }
                ]
            };

            myChart.setOption(option);
        }

        /* -------------------- DERIVADA -------------------- */
        else if (dadosOriginais.tipo === 'derivada') {
            document.getElementById('controle-derivada').style.display = 'block';

            function interpolaY(x0) {
                if (xs.length === 0) return NaN;
                if (x0 <= xs[0]) return ys[0];
                if (x0 >= xs[xs.length - 1]) return ys[ys.length - 1];
                for (let i = 0; i < xs.length - 1; i++) {
                    const x1 = xs[i], x2 = xs[i + 1];
                    const y1 = ys[i], y2 = ys[i + 1];
                    if (x0 >= x1 && x0 <= x2) {
                        if (!isFinite(y1) || !isFinite(y2)) return NaN;
                        const t = (x2 - x1) === 0 ? 0 : (x0 - x1) / (x2 - x1);
                        return y1 + t * (y2 - y1);
                    }
                }
                return NaN;
            }

            function estimaInclina√ß√£o(x0) {
                if (xs.length < 3) return 0;
                let i = xs.findIndex(v => v >= x0);
                if (i === -1) i = xs.length - 1;
                i = Math.max(1, Math.min(i, xs.length - 2));
                const xA = xs[i - 1], xB = xs[i + 1];
                const yA = ys[i - 1], yB = ys[i + 1];
                if (!isFinite(yA) || !isFinite(yB) || (xB - xA) === 0) return 0;
                return (yB - yA) / (xB - xA);
            }

            function renderTangente(xTangente) {
                const y0 = interpolaY(xTangente);
                const m = estimaInclina√ß√£o(xTangente);

                const rx = [xTangente - 1, xTangente + 1];
                const ry = rx.map(x => m * (x - xTangente) + y0);

                option = {
                    ...commonConfig,
                    title: { text: `Derivada: Reta Tangente em x = ${xTangente.toFixed(2)}`, left: 'center' },
                    legend: { data: ['f(x)', `Tangente (m = ${m.toFixed(4)})`, 'Ponto de Tang√™ncia'], top: 36 },
                    series: [
                        {
                            name: 'f(x)',
                            type: 'line',
                            data: xs.map((x, i) => [x, ys[i]]),
                            smooth: true,
                            lineStyle: { width: 2, color: '#667eea' },
                            showSymbol: false,
                            connectNulls: false,
                            z: 4
                        },
                        {
                            name: `Tangente (m = ${m.toFixed(4)})`,
                            type: 'line',
                            data: rx.map((x, i) => [rx[i], ry[i]]),
                            lineStyle: { width: 3, type: 'dashed', color: '#e74c3c' },
                            showSymbol: false,
                            z: 8
                        },
                        {
                            name: 'Ponto de Tang√™ncia',
                            type: 'scatter',
                            data: [[xTangente, y0]],
                            symbolSize: 18,
                            itemStyle: { color: '#f39c12', borderColor: '#e67e22', borderWidth: 2 },
                            label: {
                                show: true,
                                formatter: function (p) {
                                    const xv = p.value[0], yv = p.value[1];
                                    return (typeof yv === 'number' && isFinite(yv))
                                        ? `(${xv.toFixed(2)}, ${yv.toFixed(2)})`
                                        : `(${xv.toFixed(2)}, n/a)`;
                                },
                                position: 'top',
                                backgroundColor: 'rgba(255,255,255,0.95)',
                                padding: [6, 10],
                                borderRadius: 6
                            },
                            z: 10
                        }
                    ]
                };

                myChart.setOption(option);
            }

            const slider = document.getElementById('slider_ponto_tangente_form');
            const badge = document.getElementById('val_ponto_tangente_form');

            if (xs.length === 0) {
                myChart.setOption({
                    ...commonConfig,
                    title: { text: 'Sem dados para derivada', left: 'center' }
                });
            } else {
                const xInicial = 0;

                slider.min = Math.min(...xs);
                slider.max = Math.max(...xs);
                slider.step = (Math.max(...xs) - Math.min(...xs)) / (xs.length - 1) || 0.1;
                slider.value = xInicial;
                badge.innerText = parseFloat(xInicial).toFixed(2);

                renderTangente(parseFloat(xInicial));

                slider.addEventListener('input', function (e) {
                    const val = parseFloat(e.target.value);
                    badge.innerText = val.toFixed(2);
                    renderTangente(val);
                });
            }
        }

        /* -------------------- PONTOS CR√çTICOS -------------------- */
        else if (dadosOriginais.tipo === 'pontos_criticos') {
            option = {
                ...commonConfig,
                title: { text: 'Pontos Cr√≠ticos', left: 'center' },
                legend: { top: 36 },
                series: [
                    {
                        name: 'f(x)',
                        type: 'line',
                        data: xs.map((x, i) => [x, ys[i]]),
                        smooth: true,
                        lineStyle: { width: 3, color: '#667eea' },
                        showSymbol: false,
                        connectNulls: false
                    },
                    ...(Array.isArray(dadosOriginais.pontos)
                        ? dadosOriginais.pontos.map(p => ({
                            name: p.tipo,
                            type: 'scatter',
                            data: [[p.x, p.y]],
                            symbolSize: 22,
                            itemStyle: {
                                color:
                                    p.tipo.includes("M√°ximo") ? '#e74c3c' :        // vermelho forte
                                        p.tipo.includes("M√≠nimo") ? '#3498db' :        // azul forte
                                            '#e67e22',                                     // laranja forte
                                borderColor: '#000000',
                                borderWidth: 0,
                                opacity: 1       // <-- garante que n√£o fica transparente
                            }
                        }))
                        : [])
                ]
            };

            myChart.setOption(option);
        }

        /* -------------------- INTEGRAL -------------------- */
        else if (dadosOriginais.tipo === 'integral') {
            document.getElementById('controles-dinamicos').style.display = 'block';

            function calcularRetangulos(n) {
                const a = dadosOriginais.intervalo[0];
                const b = dadosOriginais.intervalo[1];
                const delta = (b - a) / n;
                const ret = [];
                let soma_liquida = 0;
                let soma_absoluta = 0;

                for (let i = 0; i < n; i++) {
                    const x_esq = a + i * delta;
                    const idx = xs.findIndex(x => x >= x_esq);
                    const altura = (idx !== -1 && ys[idx] !== null) ? ys[idx] : 0;
                    ret.push({ x: x_esq, largura: delta, altura: altura });
                    soma_liquida += altura * delta;
                    soma_absoluta += Math.abs(altura * delta);
                }

                return { retangulos: ret, soma_liquida, soma_absoluta };
            }

            function renderIntegral(n) {
                const { retangulos, soma_liquida, soma_absoluta } = calcularRetangulos(n);

                document.getElementById('integral_liquida_display').innerText =
                    (dadosOriginais.integral_liquida ?? 0).toFixed(6);
                document.getElementById('soma_liquida_display').innerText =
                    soma_liquida.toFixed(6);

                document.getElementById('area_geometrica_display').innerText =
                    (dadosOriginais.area_geometrica ?? 0).toFixed(6);
                document.getElementById('soma_absoluta_display').innerText =
                    soma_absoluta.toFixed(6);

                option = {
                    ...commonConfig,
                    title: { text: `Soma de Riemann (n = ${n})`, left: 'center' },
                    legend: { data: ['f(x)', 'Ret√¢ngulos'], top: 36 },
                    series: [
                        {
                            name: 'f(x)',
                            type: 'line',
                            data: xs.map((x, i) => [x, ys[i]]),
                            smooth: true,
                            lineStyle: { width: 3, color: '#667eea' },
                            showSymbol: false,
                            connectNulls: false,
                            z: 10
                        },
                        {
                            name: 'Ret√¢ngulos',
                            type: 'custom',
                            renderItem: function (params, api) {
                                const idx = params.dataIndex;
                                const r = retangulos[idx];
                                if (!r) return null;

                                const xStart = api.coord([r.x, 0])[0];
                                const xEnd = api.coord([r.x + r.largura, 0])[0];
                                const yZero = api.coord([0, 0])[1];
                                const yVal = api.coord([0, r.altura])[1];

                                return {
                                    type: 'rect',
                                    shape: {
                                        x: xStart,
                                        y: Math.min(yZero, yVal),
                                        width: xEnd - xStart,
                                        height: Math.abs(yZero - yVal)
                                    },
                                    style: {
                                        fill: (r.altura >= 0)
                                            ? 'rgba(52,152,219,0.45)'
                                            : 'rgba(231,76,60,0.45)',
                                        stroke: (r.altura >= 0)
                                            ? 'rgba(52,152,219,0.9)'
                                            : 'rgba(231,76,60,0.9)',
                                        lineWidth: 1
                                    }
                                };
                            },
                            data: retangulos,
                            z: 5
                        }
                    ]
                };

                myChart.setOption(option);
            }

            const sliderInt = document.getElementById('slider_dinamico');
            const badgeN = document.getElementById('val_n_dinamico');

            if (sliderInt) {
                const initN = parseInt(sliderInt.value || 10);
                badgeN.innerText = initN;
                renderIntegral(initN);

                sliderInt.addEventListener('input', function (e) {
                    const n = parseInt(e.target.value, 10) || 1;
                    badgeN.innerText = n;
                    renderIntegral(n);
                });
            }
        }

        window.addEventListener('resize', () => myChart.resize());
        }) ();
    </script>
    {% endif %}

</body>

</html>