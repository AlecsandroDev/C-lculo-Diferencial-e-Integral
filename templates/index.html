<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalcMaster - Calculadora de C√°lculo</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Open+Sans:wght@400;600&display=swap"
        rel="stylesheet">

    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <!-- MathJax -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* --- Vari√°veis de Cor (Paleta Suave) --- */
        :root {
            --bg-paper: #FDFBF7;
            --container-bg: #FFFFFF;
            --primary-color: #6B8EAD;
            --primary-hover: #557691;
            --text-dark: #3F3F3F;
            --text-light: #757575;
            --border-color: #E0DFDB;
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.05);
            --step-bg: #f8f9fa;
        }

        /* Tema Escuro */
        [data-theme="dark"] {
            --bg-paper: #1a1a1a;
            --container-bg: #2d2d2d;
            --primary-color: #81a3c4;
            --primary-hover: #6b8fad;
            --text-dark: #e8e8e8;
            --text-light: #b0b0b0;
            --border-color: #404040;
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.3);
            --step-bg: #363636;
        }

        /* --- Reset e Estilos Globais --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background-color: var(--bg-paper);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zM32 63c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm57-13c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23d1d1d1' fill-opacity='0.07' fill-rule='evenodd'/%3E%3C/svg%3E");
            color: var(--text-dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Header e Navbar --- */
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: var(--container-bg);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-soft);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .project-title {
            font-family: 'Merriweather', serif;
            font-size: 1.5rem;
            color: var(--primary-color);
            transition: color 0.3s;
        }

        .navbar {
            display: flex;
            gap: 2rem;
        }

        .nav-link {
            text-decoration: none;
            color: var(--text-light);
            font-weight: 600;
            padding-bottom: 0.5rem;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .theme-toggle-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: transparent;
            cursor: pointer;
            border-radius: 20px;
            color: var(--text-dark);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .theme-toggle-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* --- Layout Principal (Grid de 2 Colunas) --- */
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 40% 60%;
            gap: 2rem;
            padding: 2rem;
            overflow: hidden;
        }

        .panel-container {
            background-color: var(--container-bg);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* --- Painel Esquerdo --- */
        .left-panel {
            overflow-y: auto;
            max-height: calc(100vh - 120px);
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            transition: color 0.3s;
        }

        .input-field {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Open Sans', sans-serif;
            transition: all 0.3s;
            background-color: var(--container-bg);
            color: var(--text-dark);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .calc-button {
            width: 100%;
            padding: 1rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 2rem;
        }

        .calc-button:hover {
            background-color: var(--primary-hover);
        }

        .step-by-step-section h3 {
            font-family: 'Merriweather', serif;
            margin-bottom: 1rem;
            color: var(--text-dark);
            transition: color 0.3s;
        }

        .latex-step {
            background-color: var(--step-bg);
            border-left: 4px solid var(--primary-color);
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 1rem;
            transition: background-color 0.3s;
            border-radius: 4px;
        }

        /* --- Painel Direito --- */
        .right-panel {
            overflow-y: auto;
            max-height: calc(100vh - 120px);
            display: flex;
            flex-direction: column;
        }

        .latex-answer-summary {
            background-color: var(--bg-paper);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .latex-main-answer {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary-color);
            transition: color 0.3s;
        }

        .graph-container {
            flex: 1;
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            min-height: 400px;
            transition: all 0.3s;
        }

        .x-axis-sidebar {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--bg-paper);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .sidebar-label {
            display: block;
            text-align: center;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.9rem;
            transition: color 0.3s;
        }

        .x-range-slider {
            width: 100%;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: var(--border-color);
            border-radius: 5px;
            outline: none;
        }

        .x-range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .x-range-slider::-webkit-slider-thumb:hover {
            background: var(--primary-hover);
            transform: scale(1.2);
        }

        .x-range-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }

        .x-range-slider::-moz-range-thumb:hover {
            background: var(--primary-hover);
            transform: scale(1.2);
        }

        /* Esconde elementos quando n√£o h√° resultado */
        .hidden {
            display: none;
        }

        /* Responsividade */
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
                overflow-y: auto;
            }

            .left-panel,
            .right-panel {
                max-height: none;
            }

            body {
                height: auto;
            }
        }
    </style>
</head>

<body>

    <header class="main-header">
        <div class="project-title">CalcMaster</div>
        <nav class="navbar">
            <a class="nav-link {% if aba_ativa == 'limite' %}active{% endif %}" data-aba="limite">Limite</a>
            <a class="nav-link {% if aba_ativa == 'derivada' %}active{% endif %}" data-aba="derivada">Derivadas</a>
            <a class="nav-link {% if aba_ativa == 'pontos_criticos' %}active{% endif %}"
                data-aba="pontos_criticos">Pontos Cr√≠ticos</a>
            <a class="nav-link {% if aba_ativa == 'integral' %}active{% endif %}" data-aba="integral">Integral</a>
        </nav>
        <button class="theme-toggle-btn" id="themeToggle">
            üåô Tema Escuro
        </button>
    </header>

    <main class="main-content">

        <section class="panel-container left-panel">
            <form method="POST" action="/" id="calcForm">
                <input type="hidden" name="aba_ativa" id="input_aba_ativa" value="{{ aba_ativa }}">

                <div class="input-group">
                    <label for="funcao" class="input-label">Fun√ß√£o f(x)</label>
                    <input type="text" id="funcao" name="funcao" class="input-field"
                        placeholder="Ex: x**2, sin(x), 1/(x-2)" value="{{ funcao }}" required>
                    <small style="color: var(--text-light); margin-top: 0.25rem; display: block;">
                        Use: ** (pot√™ncia), sqrt(), sin/cos/tan, exp(), log()
                    </small>
                </div>

                <!-- Campos espec√≠ficos por aba -->
                <div class="input-group aba-config" id="config-limite" {% if aba_ativa !='limite'
                    %}style="display:none;" {% endif %}>
                    <label for="ponto_limite" class="input-label">Ponto de tend√™ncia (x ‚Üí p)</label>
                    <input type="number" step="any" id="ponto_limite" name="ponto_limite" class="input-field"
                        value="{{ params.ponto }}">
                </div>

                <div class="input-group aba-config" id="config-derivada" {% if aba_ativa !='derivada'
                    %}style="display:none;" {% endif %}>
                    <label for="ponto_tangente" class="input-label">Ponto da tangente (opcional)</label>
                    <input type="number" step="any" id="ponto_tangente" name="ponto_tangente" class="input-field"
                        value="{{ params.ponto_tangente }}" placeholder="0">
                </div>

                <div class="aba-config" id="config-integral" {% if aba_ativa !='integral' %}style="display:none;" {%
                    endif %}>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="input-group">
                            <label for="int_a" class="input-label">In√≠cio (a)</label>
                            <input type="number" step="any" id="int_a" name="int_a" class="input-field"
                                value="{{ params.int_a }}">
                        </div>
                        <div class="input-group">
                            <label for="int_b" class="input-label">Fim (b)</label>
                            <input type="number" step="any" id="int_b" name="int_b" class="input-field"
                                value="{{ params.int_b }}">
                        </div>
                    </div>
                </div>

                <button type="submit" class="calc-button">Calcular</button>
            </form>

            <div class="step-by-step-section {% if not steps %}hidden{% endif %}" id="stepsSection">
                <h3>Resolu√ß√£o Passo a Passo</h3>
                {% if steps %}
                {% for step in steps %}
                <div class="latex-step">$$ {{ step | safe }} $$</div>
                {% endfor %}
                {% endif %}
            </div>
        </section>

        <section class="panel-container right-panel">

            <div class="latex-answer-summary {% if not resultado %}hidden{% endif %}" id="resultSection">
                <p style="color: var(--text-light); margin-bottom: 0.5rem;">Resposta Final:</p>
                <div class="latex-main-answer">
                    {% if resultado %}
                    $$ {{ resultado | safe }} $$
                    {% endif %}
                </div>
            </div>

            <div class="graph-container" id="mainChart"></div>

            <div class="x-axis-sidebar {% if not dados_grafico or dados_grafico.tipo != 'derivada' %}hidden{% endif %}"
                id="xAxisControl">
                <span class="sidebar-label">Ponto da Tangente: <span id="xValueDisplay">0.00</span></span>
                <input type="range" min="-10" max="10" step="0.1" value="0" class="x-range-slider" id="xAxisSlider">
            </div>

            <div class="x-axis-sidebar {% if not dados_grafico or dados_grafico.tipo != 'integral' %}hidden{% endif %}"
                id="integralControl">
                <span class="sidebar-label">N√∫mero de Ret√¢ngulos: <span id="nRetDisplay">10</span></span>
                <input type="range" min="1" max="200" value="10" class="x-range-slider" id="nRetSlider">

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <div style="text-align: center;">
                        <small style="color: var(--text-light);">Integral L√≠quida</small>
                        <div style="font-weight: bold; color: var(--primary-color);" id="integralLiquida">-</div>
                    </div>
                    <div style="text-align: center;">
                        <small style="color: var(--text-light);">√Årea Geom√©trica</small>
                        <div style="font-weight: bold; color: var(--primary-color);" id="areaGeometrica">-</div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script>
        // ===== TEMA =====
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;

        // Carrega tema salvo
        const savedTheme = localStorage.getItem('theme') || 'light';
        html.setAttribute('data-theme', savedTheme);
        updateThemeButton(savedTheme);

        themeToggle.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton(newTheme);

            // Atualiza gr√°fico se existir
            if (window.myChart) {
                const chartDom = document.getElementById('mainChart');
                window.myChart.dispose();
                window.myChart = echarts.init(chartDom, newTheme === 'dark' ? 'dark' : undefined);

                // Re-renderiza o gr√°fico atual
                if (typeof window.currentRenderFunction === 'function') {
                    window.currentRenderFunction();
                }
            }
        });

        function updateThemeButton(theme) {
            themeToggle.innerHTML = theme === 'light' ? 'üåô Tema Escuro' : '‚òÄÔ∏è Tema Claro';
        }

        // ===== NAVEGA√á√ÉO =====
        const navLinks = document.querySelectorAll('.nav-link');
        const abaInput = document.getElementById('input_aba_ativa');

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const aba = link.getAttribute('data-aba');

                // Atualiza visual
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                // Atualiza campo hidden
                abaInput.value = aba;

                // Mostra/oculta campos
                document.querySelectorAll('.aba-config').forEach(el => el.style.display = 'none');
                const configEl = document.getElementById(`config-${aba}`);
                if (configEl) configEl.style.display = 'block';
            });
        });

        // ===== GR√ÅFICO =====
        {% if dados_grafico %}
        (function () {
            const dadosOriginais = {{ dados_grafico | tojson | safe
        }};
        const chartDom = document.getElementById('mainChart');

        function renderChart() {
            const isDark = html.getAttribute('data-theme') === 'dark';
            if (window.myChart) window.myChart.dispose();
            window.myChart = echarts.init(chartDom, isDark ? 'dark' : undefined);

            const xs = Array.isArray(dadosOriginais.eixo_x) ? dadosOriginais.eixo_x : [];
            const ys = Array.isArray(dadosOriginais.eixo_y)
                ? dadosOriginais.eixo_y.map(v => (typeof v === 'number' && isFinite(v) ? v : null))
                : [];

            const commonConfig = {
                toolbox: {
                    feature: {
                        restore: {},
                        saveAsImage: { name: 'calcmaster_grafico' }
                    },
                    right: 20,
                    top: 10
                },
                tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                grid: { left: '10%', right: '10%', bottom: '15%', top: '15%', containLabel: true },
                dataZoom: [
                    { type: 'inside', xAxisIndex: 0 },
                    { type: 'slider', xAxisIndex: 0, bottom: '5%' }
                ],
                xAxis: { type: 'value', name: 'x', nameLocation: 'middle', nameGap: 30 },
                yAxis: { type: 'value', name: 'f(x)', nameLocation: 'middle', nameGap: 50 }
            };

            let option = {};

            /* -------------------- LIMITE -------------------- */
            if (dadosOriginais.tipo === 'limite') {
                const pt = dadosOriginais.ponto_destaque || {};
                const yHighlight = (typeof pt.y === 'number' && isFinite(pt.y)) ? pt.y : null;
                const estilo = pt.estilo || 'nao_existe';
                const isAberta = (estilo === 'aberta');

                let labelPonto = 'Ponto';
                if (isAberta) labelPonto = 'Descont. Remov√≠vel (‚óã)';
                else if (estilo === 'fechada') labelPonto = 'Fun√ß√£o Cont√≠nua (‚óè)';

                option = {
                    ...commonConfig,
                    title: { text: 'An√°lise de Limite', left: 'center', textStyle: { fontSize: 16 } },
                    legend: { data: ['f(x)', labelPonto], top: 40 },
                    series: [
                        {
                            name: "f(x)",
                            type: "line",
                            connectNulls: false,
                            data: dadosOriginais.eixo_x.map((x, i) => {
                                const y = dadosOriginais.y_esquerda ? dadosOriginais.y_esquerda[i] : null;
                                return y === null ? null : [x, y];
                            }),
                            showSymbol: false,
                            lineStyle: { width: 3 }
                        },
                        {
                            name: "f(x)",
                            type: "line",
                            connectNulls: false,
                            data: dadosOriginais.eixo_x.map((x, i) => {
                                const y = dadosOriginais.y_direita ? dadosOriginais.y_direita[i] : null;
                                return y === null ? null : [x, y];
                            }),
                            showSymbol: false,
                            lineStyle: { width: 3 }
                        },
                        ...(yHighlight !== null ? [{
                            name: labelPonto,
                            type: 'scatter',
                            data: [[pt.x, yHighlight]],
                            symbolSize: 22,
                            itemStyle: {
                                color: isAberta ? '#ffffff' : '#e74c3c',
                                borderColor: '#e74c3c',
                                borderWidth: 3
                            },
                            label: {
                                show: true,
                                formatter: (p) => `(${p.value[0].toFixed(2)}, ${p.value[1].toFixed(2)})`,
                                position: 'top',
                                backgroundColor: 'rgba(255,255,255,0.95)',
                                padding: [6, 10],
                                borderRadius: 6,
                                color: '#333'
                            },
                            z: 10
                        }] : [])
                    ]
                };

                window.myChart.setOption(option);

                // Salva fun√ß√£o para re-renderizar ao trocar tema
                window.currentRenderFunction = function () {
                    window.myChart.setOption(option);
                };
            }

            /* -------------------- DERIVADA -------------------- */
            else if (dadosOriginais.tipo === 'derivada') {
                // Mostra o controle do slider
                const xAxisControl = document.getElementById('xAxisControl');
                if (xAxisControl) {
                    xAxisControl.classList.remove('hidden');
                }

                function avaliarExpressao(exprStr, xVal) {
                    try {
                        let jsExpr = exprStr
                            .replace(/log\(/g, 'Math.log(')
                            .replace(/exp\(/g, 'Math.exp(')
                            .replace(/sin\(/g, 'Math.sin(')
                            .replace(/cos\(/g, 'Math.cos(')
                            .replace(/tan\(/g, 'Math.tan(')
                            .replace(/sqrt\(/g, 'Math.sqrt(')
                            .replace(/x/g, `(${xVal})`);
                        const result = eval(jsExpr);
                        return (typeof result === 'number' && isFinite(result)) ? result : null;
                    } catch (e) {
                        console.error('Erro ao avaliar express√£o:', e);
                        return null;
                    }
                }

                function renderTangente(xTangente) {
                    const ptTangente = dadosOriginais.ponto_tangente || {};
                    let y0, m;

                    if (Math.abs(xTangente - (ptTangente.x || 0)) < 0.01) {
                        y0 = ptTangente.y;
                        m = ptTangente.inclinacao;
                    } else {
                        if (dadosOriginais.expr_str && dadosOriginais.deriv_str) {
                            y0 = avaliarExpressao(dadosOriginais.expr_str, xTangente);
                            m = avaliarExpressao(dadosOriginais.deriv_str, xTangente);
                        } else {
                            y0 = m = null;
                        }
                    }

                    if (y0 === null || m === null || !isFinite(y0) || !isFinite(m)) {
                        option = {
                            ...commonConfig,
                            title: { text: `x = ${xTangente.toFixed(2)} (singularidade)`, left: 'center' },
                            series: [{
                                name: 'f(x)',
                                type: 'line',
                                data: xs.map((x, i) => [x, ys[i]]),
                                smooth: true,
                                lineStyle: { width: 2 },
                                showSymbol: false,
                                connectNulls: false
                            }]
                        };
                        window.myChart.setOption(option);
                        return;
                    }

                    const extensao = 3;
                    const rx = [xTangente - extensao, xTangente + extensao];
                    const ry = rx.map(x => m * (x - xTangente) + y0);

                    option = {
                        ...commonConfig,
                        title: { text: `Reta Tangente em x = ${xTangente.toFixed(2)}`, left: 'center' },
                        legend: { data: ['f(x)', 'Tangente', 'Ponto'], top: 40 },
                        series: [
                            {
                                name: 'f(x)',
                                type: 'line',
                                data: xs.map((x, i) => [x, ys[i]]),
                                smooth: true,
                                lineStyle: { width: 2 },
                                showSymbol: false,
                                connectNulls: false
                            },
                            {
                                name: 'Tangente',
                                type: 'line',
                                data: rx.map((x, i) => [rx[i], ry[i]]),
                                lineStyle: { width: 3, type: 'dashed', color: '#e74c3c' },
                                showSymbol: false
                            },
                            {
                                name: 'Ponto',
                                type: 'scatter',
                                data: [[xTangente, y0]],
                                symbolSize: 18,
                                itemStyle: { color: '#f39c12', borderColor: '#e67e22', borderWidth: 2 },
                                label: {
                                    show: true,
                                    formatter: () => `(${xTangente.toFixed(2)}, ${y0.toFixed(2)})\nm = ${m.toFixed(4)}`,
                                    position: 'top',
                                    backgroundColor: 'rgba(255,255,255,0.95)',
                                    padding: [6, 10],
                                    borderRadius: 6,
                                    color: '#333'
                                }
                            }
                        ]
                    };
                    window.myChart.setOption(option);
                }

                // Salva a fun√ß√£o de renderiza√ß√£o para o tema
                window.currentRenderFunction = function () {
                    const slider = document.getElementById('xAxisSlider');
                    if (slider) {
                        renderTangente(parseFloat(slider.value));
                    }
                };

                // Configura o slider
                const slider = document.getElementById('xAxisSlider');
                const display = document.getElementById('xValueDisplay');

                if (slider && display) {
                    const xInicial = (dadosOriginais.ponto_tangente && dadosOriginais.ponto_tangente.x) || 0;

                    slider.min = Math.min(...xs);
                    slider.max = Math.max(...xs);
                    slider.step = '0.1';
                    slider.value = xInicial;
                    display.textContent = xInicial.toFixed(2);

                    // Renderiza o gr√°fico inicial
                    renderTangente(parseFloat(xInicial));

                    // Event listener com addEventListener (mais confi√°vel)
                    slider.addEventListener('input', function (e) {
                        const val = parseFloat(e.target.value);
                        console.log('Slider movido para:', val); // Debug
                        display.textContent = val.toFixed(2);
                        renderTangente(val);
                    });

                    // Fallback: tamb√©m adiciona onchange
                    slider.addEventListener('change', function (e) {
                        const val = parseFloat(e.target.value);
                        console.log('Slider changed para:', val); // Debug
                        display.textContent = val.toFixed(2);
                        renderTangente(val);
                    });

                    console.log('Slider da derivada configurado:', {
                        min: slider.min,
                        max: slider.max,
                        value: slider.value,
                        disabled: slider.disabled
                    });
                } else {
                    console.error('Slider ou display n√£o encontrado!');
                }
            }

            /* -------------------- PONTOS CR√çTICOS -------------------- */
            else if (dadosOriginais.tipo === 'pontos_criticos') {
                option = {
                    ...commonConfig,
                    title: { text: 'Pontos Cr√≠ticos', left: 'center' },
                    series: [
                        {
                            name: 'f(x)',
                            type: 'line',
                            data: xs.map((x, i) => [x, ys[i]]),
                            smooth: true,
                            lineStyle: { width: 3 },
                            showSymbol: false,
                            connectNulls: false
                        },
                        ...(Array.isArray(dadosOriginais.pontos)
                            ? dadosOriginais.pontos.map(p => ({
                                name: p.tipo,
                                type: 'scatter',
                                data: [[p.x, p.y]],
                                symbolSize: 22,
                                itemStyle: {
                                    color: p.tipo.includes("M√°ximo") ? '#e74c3c' :
                                        p.tipo.includes("M√≠nimo") ? '#3498db' : '#e67e22'
                                }
                            }))
                            : [])
                    ]
                };

                window.myChart.setOption(option);

                // Salva fun√ß√£o para re-renderizar ao trocar tema
                window.currentRenderFunction = function () {
                    window.myChart.setOption(option);
                };
            }

            /* -------------------- INTEGRAL -------------------- */
            else if (dadosOriginais.tipo === 'integral') {
                document.getElementById('integralControl').classList.remove('hidden');

                function getYAtX(xVal) {
                    if (xs.length === 0) return 0;
                    if (xVal <= xs[0]) return ys[0] || 0;
                    if (xVal >= xs[xs.length - 1]) return ys[ys.length - 1] || 0;

                    for (let i = 0; i < xs.length - 1; i++) {
                        if (xVal >= xs[i] && xVal <= xs[i + 1]) {
                            const y1 = ys[i], y2 = ys[i + 1];
                            if (y1 === null || y2 === null || !isFinite(y1) || !isFinite(y2)) return 0;
                            const t = (xVal - xs[i]) / (xs[i + 1] - xs[i]);
                            return y1 + t * (y2 - y1);
                        }
                    }
                    return 0;
                }

                function calcularRetangulos(n) {
                    const a = dadosOriginais.intervalo[0];
                    const b = dadosOriginais.intervalo[1];
                    const delta = (b - a) / n;
                    const ret = [];
                    let soma_liquida = 0, soma_absoluta = 0;

                    for (let i = 0; i < n; i++) {
                        const x_esq = a + i * delta;
                        const x_dir = x_esq + delta;
                        const h_esq = getYAtX(x_esq);
                        const h_dir = getYAtX(x_dir);
                        const altura = Math.abs(h_esq) < Math.abs(h_dir) ? h_esq : h_dir;

                        ret.push({ x: x_esq, largura: delta, altura });
                        soma_liquida += altura * delta;
                        soma_absoluta += Math.abs(altura * delta);
                    }
                    return { retangulos: ret, soma_liquida, soma_absoluta };
                }

                function renderIntegral(n) {
                    const { retangulos, soma_liquida, soma_absoluta } = calcularRetangulos(n);

                    document.getElementById('integralLiquida').textContent =
                        `Real: ${(dadosOriginais.integral_liquida ?? 0).toFixed(4)} | Aprox: ${soma_liquida.toFixed(4)}`;
                    document.getElementById('areaGeometrica').textContent =
                        `Real: ${(dadosOriginais.area_geometrica ?? 0).toFixed(4)} | Aprox: ${soma_absoluta.toFixed(4)}`;

                    option = {
                        ...commonConfig,
                        title: { text: `Soma de Riemann (n = ${n})`, left: 'center' },
                        legend: { data: ['f(x)', 'Ret√¢ngulos'], top: 40 },
                        series: [
                            {
                                name: 'f(x)',
                                type: 'line',
                                data: xs.map((x, i) => [x, ys[i]]),
                                smooth: true,
                                lineStyle: { width: 3 },
                                showSymbol: false,
                                connectNulls: false,
                                z: 10
                            },
                            {
                                name: 'Ret√¢ngulos',
                                type: 'custom',
                                renderItem: function (params, api) {
                                    const r = retangulos[params.dataIndex];
                                    if (!r) return null;

                                    const xStart = api.coord([r.x, 0])[0];
                                    const xEnd = api.coord([r.x + r.largura, 0])[0];
                                    const yZero = api.coord([0, 0])[1];
                                    const yVal = api.coord([0, r.altura])[1];

                                    return {
                                        type: 'rect',
                                        shape: {
                                            x: xStart,
                                            y: Math.min(yZero, yVal),
                                            width: xEnd - xStart,
                                            height: Math.abs(yZero - yVal)
                                        },
                                        style: {
                                            fill: r.altura >= 0 ? 'rgba(52,152,219,0.45)' : 'rgba(231,76,60,0.45)',
                                            stroke: r.altura >= 0 ? 'rgba(52,152,219,0.9)' : 'rgba(231,76,60,0.9)',
                                            lineWidth: 1
                                        }
                                    };
                                },
                                data: retangulos,
                                z: 5
                            }
                        ]
                    };
                    window.myChart.setOption(option);
                }

                // Salva a fun√ß√£o de renderiza√ß√£o para o tema
                window.currentRenderFunction = function () {
                    const slider = document.getElementById('nRetSlider');
                    if (slider) {
                        renderIntegral(parseInt(slider.value, 10));
                    }
                };

                const sliderInt = document.getElementById('nRetSlider');
                const displayN = document.getElementById('nRetDisplay');

                renderIntegral(10);
                sliderInt.oninput = function () {
                    const n = parseInt(this.value, 10);
                    displayN.textContent = n;
                    renderIntegral(n);
                };
            }
        }

        renderChart();
        window.addEventListener('resize', () => { if (window.myChart) window.myChart.resize(); });

        // Debug: verifica se os elementos existem
        console.log('Elementos encontrados:', {
            xAxisControl: !!document.getElementById('xAxisControl'),
            xAxisSlider: !!document.getElementById('xAxisSlider'),
            xValueDisplay: !!document.getElementById('xValueDisplay'),
            integralControl: !!document.getElementById('integralControl'),
            nRetSlider: !!document.getElementById('nRetSlider')
        });
        }) ();
        {% endif %}
    </script>

</body>

</html>