<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalcTool Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 2rem 0; }
        .main-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .nav-tabs .nav-link.active { color: #667eea; border-bottom: 3px solid #667eea; }
        .resultado-math { background: white; padding: 2rem; border-radius: 10px; text-align: center; margin: 2rem 0; font-size: 1.2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .config-aba { animation: fadeIn 0.3s; margin-top: 15px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="main-card">
        <h1 class="text-center mb-4 text-primary">CalcTool Pro</h1>

        <ul class="nav nav-tabs mb-4">
            <li class="nav-item"><button class="nav-link {% if aba_ativa == 'limite' %}active{% endif %}" onclick="mudarAba('limite')">Limites</button></li>
            <li class="nav-item"><button class="nav-link {% if aba_ativa == 'derivada' %}active{% endif %}" onclick="mudarAba('derivada')">Derivada</button></li>
            <li class="nav-item"><button class="nav-link {% if aba_ativa == 'pontos_criticos' %}active{% endif %}" onclick="mudarAba('pontos_criticos')">Pontos Críticos</button></li>
            <li class="nav-item"><button class="nav-link {% if aba_ativa == 'integral' %}active{% endif %}" onclick="mudarAba('integral')">Integral</button></li>
        </ul>

        <form method="POST" action="/">
            <input type="hidden" name="aba_ativa" id="input_aba_ativa" value="{{ aba_ativa }}">
            
            <div class="mb-3">
                <label class="form-label fw-bold">Função f(x):</label>
                <input type="text" class="form-control form-control-lg" name="funcao" value="{{ funcao }}" placeholder="Ex: x**2" required>
            </div>

            <div class="config-aba" id="div-limite" {% if aba_ativa != 'limite' %}style="display:none"{% endif %}>
                <label>Ponto (x → p):</label>
                <input type="number" step="any" class="form-control" name="ponto_limite" value="{{ params.ponto }}">
            </div>

            <div class="config-aba" id="div-derivada" {% if aba_ativa != 'derivada' %}style="display:none"{% endif %}>
                <label>Mover Reta Tangente (x): <span id="label_tg">{{ params.ponto_tangente }}</span></label>
                <input type="range" class="form-range" min="-10" max="10" step="0.1" name="ponto_tangente" id="slider_tangente" value="{{ params.ponto_tangente }}" oninput="document.getElementById('label_tg').innerText = this.value">
            </div>

            <div class="config-aba" id="div-integral" {% if aba_ativa != 'integral' %}style="display:none"{% endif %}>
                <div class="row">
                    <div class="col"><label>Início (a):</label><input type="number" step="any" class="form-control" name="int_a" value="{{ params.int_a }}"></div>
                    <div class="col"><label>Fim (b):</label><input type="number" step="any" class="form-control" name="int_b" value="{{ params.int_b }}"></div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary w-100 mt-3">Calcular</button>
        </form>

        {% if resultado %}
        <div class="mt-4">
            <h4 class="text-center">Resultado</h4>
            <div class="resultado-math">$$ {{ resultado | safe }} $$</div>

            {% if dados_grafico %}
                <div id="main-chart" style="width: 100%; height: 500px;"></div>
                <div id="ctrl-integral" style="display:none" class="mt-3 p-3 bg-light rounded">
                    <label>Número de Retângulos: <span id="val_n">10</span></label>
                    <input type="range" class="form-range" min="1" max="100" id="slider_riemann" value="10">
                </div>
            {% endif %}
            
            {% if steps %}
            <div class="mt-4 p-3 bg-light rounded">
                <h5>Passo a Passo:</h5>
                {% for step in steps %}
                    <div class="mb-2 p-2 bg-white border rounded">$$ {{ step | safe }} $$</div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script>
    function mudarAba(aba) {
        document.getElementById('input_aba_ativa').value = aba;
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.config-aba').forEach(el => el.style.display = 'none');
        if(aba==='limite') document.getElementById('div-limite').style.display='block';
        if(aba==='derivada') document.getElementById('div-derivada').style.display='block';
        if(aba==='integral') document.getElementById('div-integral').style.display='block';
    }

    {% if dados_grafico %}
    (function() {
        var dados = {{ dados_grafico | safe }};
        var myChart = echarts.init(document.getElementById('main-chart'));
        
        var common = {
            toolbox: { feature: { dataZoom: {}, restore: {}, saveAsImage: {} } },
            tooltip: { trigger: 'axis' },
            grid: { left: '10%', right: '10%' },
            xAxis: { type: 'value', minInterval: 1 },
            yAxis: { type: 'value', minInterval: 1 },
            dataZoom: [{type: 'inside'}, {type: 'slider'}]
        };

        var option = {};

        if (dados.tipo === 'limite') {
            var seriesData = [{
                name: 'f(x)', type: 'line', smooth: true, showSymbol: false,
                data: dados.eixo_x.map((x, i) => [x, dados.eixo_y[i]])
            }];

            if (dados.ponto_destaque.mostrar) {
                var isAberta = dados.ponto_destaque.estilo === 'aberta';
                seriesData.push({
                    name: 'Limite', type: 'scatter', symbolSize: 15,
                    itemStyle: { 
                        color: isAberta ? 'white' : 'red', 
                        borderColor: 'red', borderWidth: 2 
                    },
                    data: [[dados.ponto_destaque.x, dados.ponto_destaque.y]],
                    z: 10
                });
            }
            option = { ...common, title: { text: 'Análise de Limite', left: 'center' }, series: seriesData };
        }

        else if (dados.tipo === 'derivada') {
            function updateTangente(xTg) {
                var idx = dados.eixo_x.findIndex(v => v >= xTg);
                if (idx < 1) idx = 1; 
                if (idx >= dados.eixo_x.length - 1) idx = dados.eixo_x.length - 2;

                var y0 = dados.eixo_y[idx];
                var p_antes = {x: dados.eixo_x[idx-1], y: dados.eixo_y[idx-1]};
                var p_depois = {x: dados.eixo_x[idx+1], y: dados.eixo_y[idx+1]};
                var m = (p_depois.y - p_antes.y) / (p_depois.x - p_antes.x);

                var lineData = [];
                var x_min = xTg - 5, x_max = xTg + 5;
                lineData.push([x_min, m * (x_min - xTg) + y0]);
                lineData.push([x_max, m * (x_max - xTg) + y0]);

                myChart.setOption({
                    title: { text: 'Derivada e Tangente', left: 'center' },
                    series: [
                        { name: 'f(x)', type: 'line', smooth: true, data: dados.eixo_x.map((x, i) => [x, dados.eixo_y[i]]) },
                        { 
                            name: 'Tangente', type: 'line', data: lineData, 
                            lineStyle: { type: 'dashed', color: 'red' }, showSymbol: false 
                        },
                        {
                            name: 'Ponto', type: 'scatter', symbolSize: 10, itemStyle: {color: 'red'},
                            data: [[xTg, y0]]
                        }
                    ]
                });
            }

            var slider = document.getElementById('slider_tangente');
            slider.addEventListener('input', function(e) { updateTangente(parseFloat(e.target.value)); });
            updateTangente(dados.ponto_inicial);
            option = common;
        }

        else if (dados.tipo === 'pontos_criticos') {
            option = {
                ...common, title: { text: 'Pontos Críticos', left: 'center' },
                series: [
                    { name: 'f(x)', type: 'line', smooth: true, data: dados.eixo_x.map((x, i) => [x, dados.eixo_y[i]]) },
                    { 
                        name: 'Pontos', type: 'scatter', symbolSize: 15, itemStyle: {color: 'orange'},
                        data: dados.pontos.map(p => [p.x, p.y]),
                        label: { show: true, formatter: '{b}', position: 'top' }
                    }
                ]
            };
        }

        else if (dados.tipo === 'integral') {
            document.getElementById('ctrl-integral').style.display = 'block';
            
            function updateRiemann(n) {
                document.getElementById('val_n').innerText = n;
                var a = dados.intervalo[0], b = dados.intervalo[1];
                var dx = (b - a) / n;
                var rects = [];
                
                for(var i=0; i<n; i++) {
                    var xi = a + i*dx;
                    var idx = dados.eixo_x.findIndex(v => v >= xi);
                    var h = dados.eixo_y[idx] || 0;
                    rects.push({x: xi, w: dx, h: h});
                }

                myChart.setOption({
                    title: { text: 'Soma de Riemann (n='+n+')', left: 'center' },
                    series: [
                        { name: 'f(x)', type: 'line', smooth: true, z: 10, data: dados.eixo_x.map((x, i) => [x, dados.eixo_y[i]]) },
                        {
                            type: 'custom',
                            renderItem: function(params, api) {
                                var r = rects[params.dataIndex];
                                var start = api.coord([r.x, 0]);
                                var size = api.size([r.w, r.h]);
                                return {
                                    type: 'rect',
                                    shape: { x: start[0], y: start[1] - (r.h>0 ? size[1] : 0), width: size[0], height: Math.abs(size[1]) },
                                    style: { fill: r.h>0 ? 'rgba(0,0,255,0.3)' : 'rgba(255,0,0,0.3)' }
                                };
                            },
                            data: rects
                        }
                    ]
                });
            }
            var sliderR = document.getElementById('slider_riemann');
            sliderR.addEventListener('input', function(e) { updateRiemann(parseInt(e.target.value)); });
            updateRiemann(10);
            option = common;
        }

        myChart.setOption(option);
        window.onresize = myChart.resize;
    })();
    {% endif %}
</script>
</body>
</html>